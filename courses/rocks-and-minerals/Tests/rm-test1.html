<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 1 — Introduction to Minerals & Basic Concepts</title>

    <link rel="stylesheet" href="/masterlab-mvp-site/css/global.css">
    <link rel="stylesheet" href="/masterlab-mvp-site/css/test.css">
    <link rel="stylesheet" href="../rm-style.css">

    <script src="/masterlab-mvp-site/js/rm-lock.js"></script>
    <script src="/masterlab-mvp-site/js/ml-xp.js"></script>
    <script src="/masterlab-mvp-site/js/ml-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/ml-relearn-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/test.js"></script>
</head>

<body>

<script>
    RMLock.enforceTestLock(1);
</script>

<div class="test-container">

    <h1 class="lesson-title">Test 1 — Introduction to Minerals & Basic Concepts</h1>
    <p class="lesson-subtitle">MasterLab Rocks & Minerals (Division C)</p>
    <hr>

    <div id="test-container"></div>

    <script src="/masterlab-mvp-site/js/ml-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/ml-relearn-test-engine.js"></script>
    <script>
        MLTestEngine.startTest({
            lesson: 1,
            course: "rocks-and-minerals",
            questions: [
                { q: "Which property describes resistance to scratching?", a: ["Hardness","Luster","Streak","Cleavage"], c: 0 },
                { q: "What is luster?", a: ["How a mineral reflects light","Color of powdered mineral","Resistance to fracture","Crystal habit"], c: 0 },
                { q: "What does cleavage describe?", a: ["Tendency to break along flat planes","Powdered color","Hardness","Density"], c: 0 },
                { q: "What is streak?", a: ["Color of the mineral's powder","Surface shine","Crystal shape","Specific gravity"], c: 0 },
                { q: "Which term means atoms arranged in a repeating pattern?", a: ["Crystalline","Amorphous","Mineraloid","Organic"], c: 0 },
                { q: "Which is NOT a criterion for a mineral?", a: ["Organic origin","Solid","Definite chemical composition","Ordered internal structure"], c: 0 },
                { q: "What is a mineraloid?", a: ["Mineral-like substance missing one criterion","A perfect crystal","A type of rock","A fossil"], c: 0 },
                { q: "Which mineral has chemical formula SiO2?", a: ["Quartz","Halite","Calcite","Mica"], c: 0 },
                { q: "Why does crystalline structure matter?", a: ["It influences cleavage and physical properties","It defines color only","It makes minerals organic","It determines magnetic properties only"], c: 0 },
                { q: "Which property is measured relative to water?", a: ["Specific Gravity","Streak","Luster","Hardness"], c: 0 }
            ]
        });
    </script>

    <div id="score-container"></div>

</div>

<script>
    /* ============================================================
       LOAD TEST USING MLTestEngine
       ============================================================ */

    const lesson = 1;
    const attempt = MLTestEngine.getAttemptNumber(lesson);
    const test = MLTestEngine.generateTest(lesson, attempt);

    /* ============================================================
       RENDER QUESTIONS
       ============================================================ */

    function renderQuestion(q, number) {
        return `
            <div class="question-block">
                <p><strong>${number}.</strong> ${q.prompt}</p>
                ${q.choices.map(c => `
                    <label>
                        <input type="radio" name="q${number}" value="${c}">
                        ${c}
                    </label><br>
                `).join("")}
            </div>
        `;
    }

    function renderTest(test) {
        const container = document.getElementById("test-container");
        let html = "";
        let index = 1;

        test.lessonQuestions.forEach(q => html += renderQuestion(q, index++));
        test.relearnQuestions.forEach(q => html += renderQuestion(q, index++));
        test.pastQuestions.forEach(q => html += renderQuestion(q, index++));
        test.vocabQuestions.forEach(q => html += renderQuestion(q, index++));

        container.innerHTML = html;
    }

    renderTest(test);

    /* ============================================================
       GRADING LOGIC
       ============================================================ */

    function gradeTest() {
        let score = 0;
        const total = Object.keys(test.answerKey).length;

        Object.keys(test.answerKey).forEach((key, i) => {
            const selected = document.querySelector(`input[name="q${i+1}"]:checked`);
            if (selected && selected.value === test.answerKey[key]) {
                score++;
            }
        });

        const percent = Math.round((score / total) * 100);
        const container = document.getElementById("score-container");

        container.innerHTML = `<p>You scored ${score} / ${total} (${percent}%).</p>`;

        if (percent >= 70) {
            container.innerHTML += `<p class="pass">You passed this test.</p>`;

            if (attempt === 1 && !localStorage.getItem("ml_test1_xp")) {
                RMRewards.rewardTestXP(1);
                localStorage.setItem("ml_test1_xp", "earned");
                container.innerHTML += `<p class="xp-earned">+100 XP awarded.</p>`;
            }
        } else {
            container.innerHTML += `<p class="fail">You did not reach the passing score.</p>`;
        }

        document.getElementById("retry-btn").style.display = "inline-block";
    }

    document.getElementById("submit-btn").addEventListener("click", gradeTest);

    document.getElementById("retry-btn").addEventListener("click", () => {
        MLTestEngine.incrementAttempt(lesson);
        location.reload();
    });
</script>

</body>
</html>
