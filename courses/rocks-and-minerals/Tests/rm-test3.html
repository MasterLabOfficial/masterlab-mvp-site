<script src="../rm-lock.js"></script>
<script>
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterLab Test</title>

    <link rel="stylesheet" href="/masterlab-mvp-site/css/global.css">
    <link rel="stylesheet" href="/masterlab-mvp-site/css/test.css">
    <link rel="stylesheet" href="../rm-style.css">

    <script src="/masterlab-mvp-site/js/rm-lock.js"></script>
    <script src="/masterlab-mvp-site/js/ml-xp.js"></script>
    <script src="/masterlab-mvp-site/js/ml-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/ml-relearn-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/test.js"></script>
</head>

<body>

<script>
    const lesson = 3;  
    RMLock.enforceTestLock(lesson);
</script>

<div class="test-container">

    <h1 class="lesson-title">Test <span id="lesson-number"></span></h1>
    <p class="lesson-subtitle">MasterLab Rocks & Minerals (Division C)</p>
    <hr>

    <div id="test-container"></div>

    <script src="/masterlab-mvp-site/js/ml-test-engine.js"></script>
    <script src="/masterlab-mvp-site/js/ml-relearn-test-engine.js"></script>
    <script>
        MLTestEngine.startTest({
            lesson: 3,
            course: "rocks-and-minerals",
            questions: [
                { q: "What process forms igneous rocks?", a: ["Cooling and solidification of magma/lava","Compression of sediments","Heat and pressure","Metamorphism"], c: 0 },
                { q: "What is grain size?", a: ["Size of particles in a rock","Color variation","Mineral composition","Luster"], c: 0 },
                { q: "Which rock is formed by heat and pressure?", a: ["Metamorphic","Igneous","Sedimentary","Clastic"], c: 0 },
                { q: "What does 'extrusive' mean?", a: ["Lava solidifies at the surface","Cools underground","Formed by compaction","Metamorphosed"], c: 0 },
                { q: "What is porphyritic texture?", a: ["Large crystals in a fine matrix","Uniform crystals","Glassy texture","Layered bedding"], c: 0 },
                { q: "Which environment makes chemical sedimentary rocks?", a: ["Evaporation and precipitation","High-grade metamorphism","Volcanic eruption","Glacial deposition"], c: 0 },
                { q: "What controls crystal size in igneous rocks?", a: ["Cooling rate","Pressure only","Color only","Composition only"], c: 0 },
                { q: "Which rock commonly has vesicles (holes)?", a: ["Volcanic igneous rock","Marble","Shale","Limestone"], c: 0 },
                { q: "What indicates rapid cooling of magma?", a: ["Fine-grained texture","Coarse crystals","Banded foliation","Large crystals"], c: 0 },
                { q: "Which term refers to sediment settling out of water?", a: ["Deposition","Erosion","Weathering","Transport"], c: 0 }
            ]
        });
    </script>

    <div id="score-container"></div>

</div>

<script>
    document.getElementById("lesson-number").textContent = lesson;

    const attempt = MLTestEngine.getAttemptNumber(lesson);
    const test = MLTestEngine.generateTest(lesson, attempt);

    function renderQuestion(q, number) {
        return `
            <div class="question-block">
                <p><strong>${number}.</strong> ${q.prompt}</p>
                ${q.choices.map(c => `
                    <label>
                        <input type="radio" name="q${number}" value="${c}">
                        ${c}
                    </label><br>
                `).join("")}
            </div>
        `;
    }

    function renderTest(test) {
        const container = document.getElementById("test-container");
        let html = "";
        let index = 1;

        test.lessonQuestions.forEach(q => html += renderQuestion(q, index++));
        test.relearnQuestions.forEach(q => html += renderQuestion(q, index++));
        test.pastQuestions.forEach(q => html += renderQuestion(q, index++));
        test.vocabQuestions.forEach(q => html += renderQuestion(q, index++));

        container.innerHTML = html;
    }

    renderTest(test);

    function gradeTest() {
        let score = 0;
        const total = Object.keys(test.answerKey).length;

        Object.keys(test.answerKey).forEach((key, i) => {
            const selected = document.querySelector(`input[name="q${i+1}"]:checked`);
            if (selected && selected.value === test.answerKey[key]) {
                score++;
            }
        });

        const percent = Math.round((score / total) * 100);
        const container = document.getElementById("score-container");

        container.innerHTML = `<p>You scored ${score} / ${total} (${percent}%).</p>`;

        if (percent >= 70) {
            container.innerHTML += `<p class="pass">You passed this test.</p>`;

            if (attempt === 1 && !localStorage.getItem(`ml_test_${lesson}_xp`)) {
                RMRewards.rewardTestXP(lesson);
                localStorage.setItem(`ml_test_${lesson}_xp`, "earned");
                container.innerHTML += `<p class="xp-earned">+100 XP awarded.</p>`;
            }
        } else {
            container.innerHTML += `<p class="fail">You did not reach the passing score.</p>`;
        }

        document.getElementById("retry-btn").style.display = "inline-block";
    }

    document.getElementById("submit-btn").addEventListener("click", gradeTest);

    document.getElementById("retry-btn").addEventListener("click", () => {
        MLTestEngine.incrementAttempt(lesson);
        location.reload();
    });
</script>

</body>
</html>
</script>


